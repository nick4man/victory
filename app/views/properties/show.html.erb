<%# –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±—ä–µ–∫—Ç–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ - properties/show.html.erb %>
<% content_for :meta_tags do %>
  <%= tag.meta name: 'description', content: @property.meta_description || @property.generate_meta_description %>
  <%= tag.meta property: 'og:type', content: 'product' %>
  <%= tag.meta property: 'og:title', content: @property.title %>
  <%= tag.meta property: 'og:description', content: @property.short_description %>
  <%= tag.meta property: 'og:image', content: @property.primary_image&.url %>
  <%= tag.meta property: 'og:price:amount', content: @property.price %>
  <%= tag.meta property: 'og:price:currency', content: 'RUB' %>
<% end %>

<div class="bg-gray-50 min-h-screen" data-controller="property-detail">
  <!-- Hero Section with Gallery -->
  <section class="bg-white">
    <div class="container mx-auto px-4 py-6">
      <!-- Breadcrumbs -->
      <nav class="flex items-center space-x-2 text-sm text-gray-600 mb-6">
        <%= link_to "–ì–ª–∞–≤–Ω–∞—è", root_path, class: "hover:text-primary-600 transition" %>
        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <%= link_to "–ö–∞—Ç–∞–ª–æ–≥", properties_path, class: "hover:text-primary-600 transition" %>
        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="text-gray-900"><%= @property.title.truncate(50) %></span>
      </nav>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column: Gallery and Info -->
        <div class="lg:col-span-2">
          <!-- Image Gallery -->
          <div class="mb-8" data-controller="gallery">
            <!-- Main Image -->
            <div class="relative bg-gray-900 rounded-xl overflow-hidden mb-4 group">
              <% if @property.images.attached? && @property.images.any? %>
                <div class="aspect-w-16 aspect-h-9 h-96 md:h-[500px]">
                  <%= image_tag @property.images.first, 
                      alt: @property.title, 
                      class: "w-full h-full object-cover",
                      data: { gallery_target: "mainImage" } %>
                </div>
              <% else %>
                <div class="h-96 md:h-[500px] flex items-center justify-center bg-gradient-to-br from-gray-200 to-gray-300">
                  <svg class="w-32 h-32 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
+                  </svg>
+                </div>
              <% end %>

              <!-- Gallery Navigation Arrows -->
              <% if @property.images.count > 1 %>
                <button type="button" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-75 text-white p-3 rounded-full transition opacity-0 group-hover:opacity-100" data-action="click->gallery#previous">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                  </svg>
                </button>
                <button type="button" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-75 text-white p-3 rounded-full transition opacity-0 group-hover:opacity-100" data-action="click->gallery#next">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
              <% end %>

              <!-- Image Counter -->
              <div class="absolute bottom-4 right-4 bg-black bg-opacity-60 text-white px-4 py-2 rounded-lg text-sm font-medium">
                <span data-gallery-target="currentIndex">1</span> / <%= @property.images.count %>
              </div>

              <!-- Fullscreen Button -->
              <button type="button" class="absolute bottom-4 left-4 bg-black bg-opacity-60 hover:bg-opacity-75 text-white p-2 rounded-lg transition" data-action="click->gallery#openFullscreen" title="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                </svg>
              </button>
            </div>

            <!-- Thumbnails -->
            <% if @property.images.count > 1 %>
              <div class="grid grid-cols-4 md:grid-cols-6 gap-2">
                <% @property.images.take(12).each_with_index do |image, index| %>
                  <button type="button" class="aspect-square rounded-lg overflow-hidden border-2 border-transparent hover:border-primary-600 transition" data-action="click->gallery#selectImage" data-index="<%= index %>">
                    <%= image_tag image.variant(resize_to_limit: [200, 200]), 
                        alt: "#{@property.title} - —Ñ–æ—Ç–æ #{index + 1}", 
                        class: "w-full h-full object-cover",
                        loading: "lazy" %>
                  </button>
                <% end %>
                <% if @property.images.count > 12 %>
                  <button type="button" class="aspect-square rounded-lg bg-gray-900 bg-opacity-80 flex items-center justify-center text-white font-bold hover:bg-opacity-90 transition" data-action="click->gallery#showAllPhotos">
                    +<%= @property.images.count - 12 %>
                  </button>
                <% end %>
              </div>
            <% end %>
          </div>

          <!-- Property Title and Price -->
          <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mb-6">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between mb-6">
              <div class="flex-1 mb-4 md:mb-0">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
                  <%= @property.title %>
                </h1>
                <div class="flex items-center text-gray-600 mb-2">
                  <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                  <%= @property.full_address %>
                </div>
                <% if @property.metro_station.present? %>
                  <div class="flex items-center text-gray-600 text-sm">
                    <svg class="w-4 h-4 mr-2 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                    </svg>
                    –º. <%= @property.metro_station %>
                    <% if @property.metro_distance %>
                      <span class="ml-2">‚Ä¢ <%= @property.metro_walking_distance? ? 'üö∂' : 'üöå' %> <%= @property.metro_distance %>–º</span>
                    <% end %>
                  </div>
                <% end %>
              </div>

              <div class="text-right">
                <div class="text-4xl md:text-5xl font-bold text-primary-600 mb-2">
                  <%= @property.price_formatted %>
                </div>
                <% if @property.price_per_sqm %>
                  <div class="text-lg text-gray-600">
                    <%= @property.price_per_sqm_formatted %>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Main Characteristics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 py-6 border-y border-gray-200">
              <div class="text-center">
                <div class="text-3xl font-bold text-gray-900 mb-1"><%= @property.area %></div>
                <div class="text-sm text-gray-600">–º¬≤ –æ–±—â–∞—è</div>
              </div>
              <% if @property.rooms %>
                <div class="text-center">
                  <div class="text-3xl font-bold text-gray-900 mb-1"><%= @property.rooms %></div>
                  <div class="text-sm text-gray-600">–∫–æ–º–Ω–∞—Ç</div>
                </div>
              <% end %>
              <% if @property.floor && @property.total_floors %>
                <div class="text-center">
                  <div class="text-3xl font-bold text-gray-900 mb-1"><%= @property.floor %>/<%= @property.total_floors %></div>
                  <div class="text-sm text-gray-600">—ç—Ç–∞–∂</div>
                </div>
              <% end %>
              <% if @property.building_year %>
                <div class="text-center">
                  <div class="text-3xl font-bold text-gray-900 mb-1"><%= @property.building_year %></div>
                  <div class="text-sm text-gray-600">–≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏</div>
                </div>
              <% end %>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
              <button type="button" class="flex items-center justify-center bg-primary-600 hover:bg-primary-700 text-white font-bold py-4 px-6 rounded-lg transition shadow-lg" data-action="click->property-detail#showPhone">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                </svg>
                <span data-property-detail-target="phoneButton">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω</span>
              </button>

              <button type="button" class="flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition shadow-lg" data-action="click->property-detail#openScheduleModal">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø–æ–∫–∞–∑
              </button>

              <% if user_signed_in? %>
                <button type="button" 
                        class="flex items-center justify-center <%= @is_favorited ? 'bg-red-500 hover:bg-red-600' : 'bg-white border-2 border-gray-300 hover:border-red-500 text-gray-700 hover:text-red-500' %> font-bold py-4 px-6 rounded-lg transition shadow-lg" 
                        data-controller="favorite"
                        data-favorite-property-id-value="<%= @property.id %>"
                        data-favorite-favorited-value="<%= @is_favorited %>"
                        data-action="click->favorite#toggle">
                  <svg class="w-5 h-5 mr-2" fill="<%= @is_favorited ? 'currentColor' : 'none' %>" stroke="currentColor" viewBox="0 0 24 24" data-favorite-target="icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  <span data-favorite-target="text"><%= @is_favorited ? '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' %></span>
                </button>
              <% else %>
                <%= link_to new_user_session_path, class: "flex items-center justify-center bg-white border-2 border-gray-300 hover:border-red-500 text-gray-700 hover:text-red-500 font-bold py-4 px-6 rounded-lg transition shadow-lg" do %>
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
                <% end %>
              <% end %>
            </div>
          </div>

          <!-- Description -->
          <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">–û–ø–∏—Å–∞–Ω–∏–µ</h2>
            <div class="text-gray-700 leading-relaxed whitespace-pre-line">
              <%= @property.description || "–û–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–∑–∂–µ" %>
            </div>
          </div>

          <!-- Detailed Characteristics -->
          <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
              <!-- Building Info -->
              <div class="flex justify-between py-3 border-b border-gray-100">
                <span class="text-gray-600">–¢–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏:</span>
                <span class="font-semibold text-gray-900"><%= @property.property_type&.name || '–ö–≤–∞—Ä—Ç–∏—Ä–∞' %></span>
              </div>
              
              <div class="flex justify-between py-3 border-b border-gray-100">
                <span class="text-gray-600">–¢–∏–ø —Å–¥–µ–ª–∫–∏:</span>
                <span class="font-semibold text-gray-900"><%= @property.deal_type_i18n.capitalize %></span>
              </div>

              <div class="flex justify-between py-3 border-b border-gray-100">
                <span class="text-gray-600">–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å:</span>
                <span class="font-semibold text-gray-900"><%= @property.area %> –º¬≤</span>
              </div>

              <% if @property.living_area %>
                <div class="flex justify-between py-3 border-b border-gray-100">
                  <span class="text-gray-600">–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å:</span>
                  <span class="font-semibold text-gray-900"><%= @property.living_area %> –º¬≤</span>
                </div>
              <% end %>

              <% if @property.kitchen_area %>
                <div class="flex justify-between py-3 border-b border-gray-100">
                  <span class="text-gray-600">–ü–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏:</span>
                  <span class="font-semibold text-gray-900"><%= @property.kitchen_area %> –º¬≤</span>
                </div>
              <% end %>

              <% if @property.rooms %>
                <div class="flex justify-between py-3 border-b border-gray-100">
                  <span class="text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç:</span>
                  <span class="font-semibold text-gray-900"><%= @property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : @property.rooms %></span>
                </div>
              <% end %>

              <% if @property.floor && @property.total_floors %>
                <div class="flex justify-between py-3 border-b border-gray-100">
                  <span class="text-gray-600">–≠—Ç–∞–∂:</span>
                  <span class="font-semibold text-gray-900"><%= @property.floor %> –∏–∑ <%= @property.total_floors %></span>
                </div>
              <% end %>

              <% if @property.building_year %>
                <div class="flex justify-between py-3 border-b border-gray-100">
                  <span class="text-gray-600">–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏:</span>
                  <span class="font-semibold text-gray-900"><%= @property.building_year %></span>
                </div>
              <% end %>

              <% if @property.building_type %>
                <div class="flex justify-between py-3 border-b border-gray-100">
                  <span class="text-gray-600">–¢–∏–ø –¥–æ–º–∞:</span>
                  <span class="font-semibold text-gray-900"><%= @property.building_type.capitalize %></span>
                </div>
              <% end %>

              <% if @property.condition %>
                <div class="flex justify-between py-3 border-b border-gray-100">
                  <span class="text-gray-600">–°–æ—Å—Ç–æ—è–Ω–∏–µ:</span>
                  <span class="font-semibold text-gray-900"><%= @property.condition_i18n %></span>
                </div>
              <% end %>

              <% if @property.ceiling_height %>
                <div class="flex justify-between py-3 border-b border-gray-100">
                  <span class="text-gray-600">–í—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–æ–≤:</span>
                  <span class="font-semibold text-gray-900"><%= @property.ceiling_height %></span>
                </div>
              <% end %>

              <% if @property.bathrooms %>
                <div class="flex justify-between py-3 border-b border-gray-100">
                  <span class="text-gray-600">–°–∞–Ω—É–∑–ª–æ–≤:</span>
                  <span class="font-semibold text-gray-900"><%= @property.bathrooms %></span>
                </div>
              <% end %>
            </div>

            <!-- Features -->
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h3 class="text-lg font-bold text-gray-900 mb-4">–£–¥–æ–±—Å—Ç–≤–∞</h3>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <% if @property.has_parking %>
                  <div class="flex items-center text-gray-700">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    –ü–∞—Ä–∫–æ–≤–∫–∞
                  </div>
                <% end %>

                <% if @property.has_balcony %>
                  <div class="flex items-center text-gray-700">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    –ë–∞–ª–∫–æ–Ω
                  </div>
                <% end %>

                <% if @property.has_elevator %>
                  <div class="flex items-center text-gray-700">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    –õ–∏—Ñ—Ç
                  </div>
                <% end %>

                <% if @property.has_security %>
                  <div class="flex items-center text-gray-700">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    –û—Ö—Ä–∞–Ω–∞
                  </div>
                <% end %>

                <% if @property.pets_allowed %>
                  <div class="flex items-center text-gray-700">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    –ú–æ–∂–Ω–æ —Å –ø–∏—Ç–æ–º—Ü–∞–º–∏
                  </div>
                <% end %>

                <% if @property.furniture.present? %>
                  <div class="flex items-center text-gray-700">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <%= @property.furniture %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Virtual Tour -->
          <% if @property.virtual_tour_url.present? %>
            <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mb-6">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π 3D-—Ç—É—Ä</h2>
              <div class="relative bg-gray-900 rounded-lg overflow-hidden" style="padding-bottom: 56.25%;">
                <iframe src="<%= @property.virtual_tour_url %>" 
                        class="absolute top-0 left-0 w-full h-full"
                        frameborder="0" 
                        allowfullscreen
                        loading="lazy"></iframe>
              </div>
            </div>
          <% end %>

          <!-- Location Map -->
          <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h2>
            
            <% if @property.latitude && @property.longitude %>
              <div class="h-96 bg-gray-200 rounded-lg mb-4" 
                   data-controller="yandex-map"
                   data-yandex-map-latitude-value="<%= @property.latitude %>"
                   data-yandex-map-longitude-value="<%= @property.longitude %>"
                   data-yandex-map-title-value="<%= @property.title %>"
                   data-yandex-map-price-value="<%= @property.price_formatted %>">
                <!-- Yandex Map will be inserted here -->
              </div>
            <% else %>
              <div class="h-96 bg-gray-200 rounded-lg flex items-center justify-center text-gray-500">
                <div class="text-center">
                  <svg class="w-16 h-16 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                  </svg>
                  <p>–ö–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞</p>
                </div>
              </div>
            <% end %>

            <!-- Infrastructure -->
            <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="text-center p-4 bg-gray-50 rounded-lg">
                <svg class="w-8 h-8 text-blue-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                  <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222"/>
                </svg>
                <div class="text-sm text-gray-600">–®–∫–æ–ª—ã</div>
              </div>

              <div class="text-center p-4 bg-gray-50 rounded-lg">
                <svg class="w-8 h-8 text-green-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                </svg>
                <div class="text-sm text-gray-600">–ú–∞–≥–∞–∑–∏–Ω—ã</div>
              </div>

              <div class="text-center p-4 bg-gray-50 rounded-lg">
                <svg class="w-8 h-8 text-red-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.871 4A17.926 17.926 0 003 12c0 2.874.673 5.59 1.871 8m14.13 0a17.926 17.926 0 001.87-8c0-2.874-.673-5.59-1.87-8M9 9h1.246a1 1 0 01.961.725l1.586 5.55a1 1 0 00.961.725H15m1-7h-.08a2 2 0 00-1.519.698L9.6 15.302A2 2 0 018.08 16H5"/>
+                </svg>
+                <div class="text-sm text-gray-600">–ê–ø—Ç–µ–∫–∏</div>
+              </div>
+
+              <div class="text-center p-4 bg-gray-50 rounded-lg">
+                <svg class="w-8 h-8 text-green-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
+                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
+                </svg>
+                <div class="text-sm text-gray-600">–ü–∞—Ä–∫–∏</div>
+              </div>
+            </div>
+          </div>
+
+          <!-- Price History -->
+          <% if defined?(@price_history) && @price_history.present? %>
+            <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mb-6">
+              <h2 class="text-2xl font-bold text-gray-900 mb-6">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã</h2>
+              
+              <div class="space-y-3">
+                <% @price_history.each do |history| %>
+                  <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">
+                    <div>
+                      <div class="font-semibold text-gray-900"><%= number_to_currency(history.price, unit: '‚ÇΩ', separator: ',', delimiter: ' ') %></div>
+                      <div class="text-sm text-gray-500"><%= l(history.changed_at, format: :long) %></div>
+                    </div>
+                    <% if history.changed_from %>
+                      <% change = ((history.price - history.changed_from) / history.changed_from * 100).round(1) %>
+                      <div class="<%= change > 0 ? 'text-red-600' : 'text-green-600' %> font-semibold">
+                        <%= change > 0 ? '+' : '' %><%= change %>%
+                      </div>
+                    <% end %>
+                  </div>
+                <% end %>
+              </div>
+            </div>
+          <% end %>
+
+          <!-- Similar Properties -->
+          <% if @similar_properties.present? %>
+            <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mb-6">
+              <h2 class="text-2xl font-bold text-gray-900 mb-6">–ü–æ—Ö–æ–∂–∏–µ –æ–±—ä–µ–∫—Ç—ã</h2>
+              
+              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
+                <% @similar_properties.each do |similar| %>
+                  <%= render partial: 'properties/property_card', locals: { property: similar } %>
+                <% end %>
+              </div>
+            </div>
+          <% end %>
+        </div>
+
+        <!-- Right Column: Sidebar -->
+        <div class="lg:col-span-1">
+          <div class="sticky top-24 space-y-6">
+            <!-- Contact Form -->
+            <div class="bg-white rounded-lg shadow-md p-6">
+              <h3 class="text-xl font-bold text-gray-900 mb-4">–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å?</h3>
+              
+              <%= form_with url: property_inquiries_path(@property), method: :post, class: "space-y-4", data: { controller: "form-submit" } do |f| %>
+                <%= hidden_field_tag 'inquiry[property_id]', @property.id %>
+                <%= hidden_field_tag 'inquiry[inquiry_type]', 'contact_agent' %>
+                
+                <div>
+                  <%= text_field_tag 'inquiry[name]', nil, placeholder: "–í–∞—à–µ –∏–º—è", required: true, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" %>
+                </div>
+                
+                <div>
+                  <%= telephone_field_tag 'inquiry[phone]', nil, placeholder: "+7 (___) ___-__-__", required: true, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" %>
+                </div>
+                
+                <div>
+                  <%= email_field_tag 'inquiry[email]', nil, placeholder: "Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)", class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" %>
+                </div>
+                
+                <div>
+                  <%= text_area_tag 'inquiry[message]', nil, rows: 3, placeholder: "–í–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...", class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" %>
+                </div>
+
+                <div class="text-xs text-gray-500">
+                  –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å <%= link_to "–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏", privacy_path, class: "text-primary-600 hover:underline", target: "_blank" %>
+                </div>
+                
+                <%= submit_tag "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É", class: "w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-3 px-6 rounded-lg transition cursor-pointer" %>
+              <% end %>
+            </div>
+
+            <!-- Mortgage Calculator Widget -->
+            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-md p-6 border border-blue-200">
+              <h3 class="text-xl font-bold text-gray-900 mb-4">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏–ø–æ—Ç–µ–∫–∏</h3>
+              
+              <div class="space-y-4" data-controller="mortgage-calculator" data-mortgage-calculator-price-value="<%= @property.price %>">
+                <div>
+                  <label class="block text-sm font-medium text-gray-700 mb-2">–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å</label>
+                  <input type="number" data-mortgage-calculator-target="initialPayment" value="<%= (@property.price * 0.2).to_i %>" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm" data-action="input->mortgage-calculator#calculate">
+                </div>
+                
+                <div>
+                  <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∞–≤–∫–∞ (%)</label>
+                  <input type="number" step="0.1" data-mortgage-calculator-target="rate" value="<%= ENV['DEFAULT_MORTGAGE_RATE'] || '10.5' %>" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm" data-action="input->mortgage-calculator#calculate">
+                </div>
+                
+                <div>
+                  <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ä–æ–∫ (–ª–µ—Ç)</label>
+                  <input type="number" data-mortgage-calculator-target="term" value="20" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm" data-action="input->mortgage-calculator#calculate">
+                </div>
+
+                <div class="bg-white rounded-lg p-4 text-center">
+                  <div class="text-sm text-gray-600 mb-1">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂</div>
+                  <div class="text-2xl font-bold text-primary-600" data-mortgage-calculator-target="result">
+                    0 ‚ÇΩ
+                  </div>
+                </div>
+
+                <%= link_to "–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å—á–µ—Ç", services_mortgage_calculator_path, class: "block w-full text-center bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-4 rounded-lg transition text-sm" %>
+              </div>
+            </div>
+
+            <!-- Property Stats -->
+            <div class="bg-white rounded-lg shadow-md p-6">
+              <h3 class="text-lg font-bold text-gray-900 mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</h3>
+              
+              <div class="space-y-3">
+                <div class="flex items-center justify-between">
+                  <span class="text-gray-600 text-sm">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤:</span>
+                  <span class="font-semibold text-gray-900"><%= @property.views_count %></span>
+                </div>
+                
+                <div class="flex items-center justify-between">
+                  <span class="text-gray-600 text-sm">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º:</span>
+                  <span class="font-semibold text-gray-900"><%= @property.favorites_count %></span>
+                </div>
+                
+                <div class="flex items-center justify-between">
+                  <span class="text-gray-600 text-sm">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ:</span>
+                  <span class="font-semibold text-gray-900"><%= time_ago_in_words(@property.created_at) %> –Ω–∞–∑–∞–¥</span>
+                </div>
+              </div>
+            </div>
+
+            <!-- Share Buttons -->
+            <div class="bg-white rounded-lg shadow-md p-6">
+              <h3 class="text-lg font-bold text-gray-900 mb-4">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</h3>
+              
+              <div class="grid grid-cols-3 gap-3">
+                <button type="button" class="flex flex-col items-center justify-center p-3 border border-gray-300 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition" data-action="click->property-detail#shareVk">
+                  <svg class="w-6 h-6 text-blue-600 mb-1" fill="currentColor" viewBox="0 0 24 24">
+                    <path d="M15.07 2H8.93C3.33 2 2 3.33 2 8.93v6.14C2 20.67 3.33 22 8.93 22h6.14c5.6 0 6.93-1.33 6.93-6.93V8.93C22 3.33 20.67 2 15.07 2z"/>
+                  </svg>
+                  <span class="text-xs text-gray-600">VK</span>
+                </button>
+
+                <button type="button" class="flex flex-col items-center justify-center p-3 border border-gray-300 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition" data-action="click->property-detail#shareTelegram">
+                  <svg class="w-6 h-6 text-blue-400 mb-1" fill="currentColor" viewBox="0 0 24 24">
+                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
+                  </svg>
+                  <span class="text-xs text-gray-600">Telegram</span>
+                </button>

+                <button type="button" class="flex flex-col items-center justify-center p-3 border border-gray-300 rounded-lg hover:border-green-600 hover:bg-green-50 transition" data-action="click->property-detail#shareWhatsapp">
+                  <svg class="w-6 h-6 text-green-600 mb-1" fill="currentColor" viewBox="0 0 24 24">
+                    <path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.582 2.128 2.182-.573c.978.58 1.911.928 3.145.929 3.178 0 5.767-2.587 5.768-5.766.001-3.187-2.575-5.77-5.764-5.771z"/>
+                  </svg>
+                  <span class="text-xs text-gray-600">WhatsApp</span>
+                </button>
+              </div>

+              <button type="button" class="mt-3 w-full flex items-center justify-center py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition text-sm" data-action="click->property-detail#copyLink">
+                <svg class="w-4 h-4 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
+                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
+                </svg>
+                –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
+              </button>
+            </div>

+            <!-- Report Problem -->
+            <div class="bg-white rounded-lg shadow-md p-6">
+              <button type="button" class="w-full text-left text-sm text-gray-600 hover:text-red-600 transition flex items-center" data-action="click->property-detail#openReportModal">
+                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
+                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
+                </svg>
+                –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
+              </button>
+            </div>
+          </div>
+        </div>
+      </div>
+    </div>
+  </section>
+</div>

+<!-- Schedule Viewing Modal -->
+<div class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" data-property-detail-target="scheduleModal">
+  <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
+    <div class="flex items-center justify-between mb-4">
+      <h3 class="text-xl font-bold text-gray-900">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø–æ–∫–∞–∑</h3>
+      <button type="button" data-action="click->property-detail#closeScheduleModal" class="text-gray-400 hover:text-gray-600">
+        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
+          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
+        </svg>
+      </button>
+    </div>

+    <%= form_with url: property_schedule_viewing_path(@property), method: :post, class: "space-y-4" do |f| %>
+      <div>
+        <label class="block text-sm font-medium text-gray-700 mb-2">–ò–º—è</label>
+        <%= text_field_tag 'name', nil, required: true, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" %>
+      </div>
+
+      <div>
+        <label class="block text-sm font-medium text-gray-700 mb-2">–¢–µ–ª–µ—Ñ–æ–Ω</label>
+        <%= telephone_field_tag 'phone', nil, required: true, placeholder: "+7 (___) ___-__-__", class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" %>
+      </div>

+      <div>
+        <label class="block text-sm font-medium text-gray-700 mb-2">–ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–∞—è –¥–∞—Ç–∞</label>
+        <%= date_field_tag 'preferred_date', nil, min: Date.current, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" %>
+      </div>

+      <div>
+        <label class="block text-sm font-medium text-gray-700 mb-2">–í—Ä–µ–º—è</label>
+        <%= select_tag 'preferred_time', options_for_select([
+          ['9:00 - 10:00', '09:00'],
+          ['10:00 - 11:00', '10:00'],
+          ['11:00 - 12:00', '11:00'],
+          ['12:00 - 13:00', '12:00'],
+          ['14:00 - 15:00', '14:00'],
+          ['15:00 - 16:00', '15:00'],
+          ['16:00 - 17:00', '16:00'],
+          ['17:00 - 18:00', '17:00'],
+          ['18:00 - 19:00', '18:00']
+        ]), class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500" %>
+      </div>

+      <div class="flex space-x-3">
+        <%= submit_tag "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è", class: "flex-1 bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-6 rounded-lg transition cursor-pointer" %>
+        <button type="button" data-action="click->property-detail#closeScheduleModal" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg transition">
+          –û—Ç–º–µ–Ω–∞
+        </button>
+      </div>
+    <% end %>
+  </div>
+</div>

+<!-- Schema.org Markup for SEO -->
+<script type="application/ld+json">
+{
+  "@context": "https://schema.org",
+  "@type": "RealEstateListing",
+  "name": "<%= @property.title %>",
+  "description": "<%= @property.short_description %>",
+  "url": "<%= property_url(@property) %>",
+  "price": "<%= @property.price %>",
+  "priceCurrency": "RUB",
+  "address": {
+    "@type": "PostalAddress",
+    "streetAddress": "<%= @property.address %>",
+    "addressLocality": "<%= @property.district %>"
+  },
+  "numberOfRooms": "<%= @property.rooms %>",
+  "floorSize": {
+    "@type": "QuantitativeValue",
+    "value": "<%= @property.area %>",
+    "unitCode": "MTK"
+  }
+  <% if @property.images.attached? && @property.images.first %>
+  ,
+  "image": "<%= url_for(@property.images.first) %>"
+  <% end %>
+}
+</script>